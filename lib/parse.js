"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const decode_1 = require("./decode");
/**
 * Cache non-integer test regexp.
 */
const isint = /^[0-9]+$/;
function promote(parent, key) {
    if (parent[key].length === 0) {
        return parent[key] = {};
    }
    let t = {};
    for (let i in parent[key]) {
        if (parent[key].hasOwnProperty(i)) {
            t[i] = parent[key][i];
        }
    }
    parent[key] = t;
    return t;
}
function _parse(parts, parent, key, val) {
    let part = parts.shift();
    // illegal
    if (Object.hasOwnProperty.call(Object.prototype, key)) {
        return;
    }
    // end
    if (!part) {
        if (Array.isArray(parent[key])) {
            parent[key].push(val);
        }
        else if ('object' === typeof parent[key]) {
            parent[key] = val;
        }
        else if ('undefined' === typeof parent[key]) {
            parent[key] = val;
        }
        else {
            parent[key] = [parent[key], val];
        }
        // array
    }
    else {
        let obj = parent[key] = parent[key] || [];
        if (']' === part) {
            if (Array.isArray(obj)) {
                if ('' !== val) {
                    obj.push(val);
                }
            }
            else if ('object' === typeof obj) {
                obj[Object.keys(obj).length] = val;
            }
            else {
                obj = parent[key] = [parent[key], val];
            }
            // prop
        }
        else if (~part.indexOf(']')) {
            part = part.substr(0, part.length - 1);
            if (!isint.test(part) && Array.isArray(obj)) {
                obj = promote(parent, key);
            }
            _parse(parts, obj, part, val);
            // key
        }
        else {
            if (!isint.test(part) && Array.isArray(obj)) {
                obj = promote(parent, key);
            }
            _parse(parts, obj, part, val);
        }
    }
}
/**
 * Merge parent key/val pair.
 */
function merge(parent, key, val) {
    if (~key.indexOf(']')) {
        let parts = key.split('[');
        let len = parts.length;
        let last = len - 1;
        _parse(parts, parent, 'base', val);
        // optimize
    }
    else {
        if (!isint.test(key) && Array.isArray(parent.base)) {
            let t = {};
            for (let k in parent.base) {
                t[k] = parent.base[k];
            }
            parent.base = t;
        }
        set(parent.base, key, val);
    }
    return parent;
}
/**
 * Compact sparse arrays.
 */
function compact(obj) {
    if ('object' !== typeof obj) {
        return obj;
    }
    if (Array.isArray(obj)) {
        let ret = [];
        for (let i in obj) {
            if (Object.hasOwnProperty.call(obj, i)) {
                ret.push(obj[i]);
            }
        }
        return ret;
    }
    for (let key in obj) {
        obj[key] = compact(obj[key]);
    }
    return obj;
}
/**
 * Parse the given obj.
 */
function parseObject(obj) {
    let ret = { base: {} };
    Object.keys(obj).forEach(function (name) {
        merge(ret, name, obj[name]);
    });
    return compact(ret.base);
}
/**
 * Parse the given str.
 */
function parseString(str, options) {
    let ret = String(str).split('&').reduce(function (ret, pair) {
        let eql = pair.indexOf('=');
        let brace = lastBraceInKey(pair);
        let key = pair.substr(0, brace || eql);
        let val = pair.substr(brace || eql, pair.length);
        val = val.substr(val.indexOf('=') + 1, val.length);
        // ?foo
        if ('' === key) {
            key = pair;
            val = '';
        }
        if ('' === key) {
            return ret;
        }
        let charset = options.charset;
        return merge(ret, decode_1.decode(key), decode_1.decode(val, charset));
    }, {
        base: {}
    }).base;
    return compact(ret);
}
/**
 * Set `obj`'s `key` to `val` respecting
 * the weird and wonderful syntax of a qs,
 * where "foo=bar&foo=baz" becomes an array.
 *
 * @param {Object} obj
 * @param {String} key
 * @param {String} val
 * @api private
 */
function set(obj, key, val) {
    let v = obj[key];
    if (Object.hasOwnProperty.call(Object.prototype, key)) {
        return;
    }
    if (undefined === v) {
        obj[key] = val;
    }
    else if (Array.isArray(v)) {
        v.push(val);
    }
    else {
        obj[key] = [v, val];
    }
}
/**
 * Locate last brace in `str` within the key.
 *
 * @param {String} str
 * @return {Number}
 * @api private
 */
function lastBraceInKey(str) {
    let len = str.length;
    let brace;
    let c;
    for (let i = 0; i < len; ++i) {
        c = str[i];
        if (']' === c) {
            brace = false;
        }
        if ('[' === c) {
            brace = true;
        }
        if ('=' === c && !brace) {
            return i;
        }
    }
}
/**
 * Parse the given query `str` or `obj`, returning an object.
 *
 * @param {String} str | {Object} obj
 * @return {Object}
 * @api public
 */
function parse(str, options) {
    if (null === str || '' === str) {
        return {};
    }
    if (!options) {
        options = {};
    }
    return 'object' === typeof str
        ? parseObject(str)
        : parseString(str, options);
}
exports.parse = parse;
exports.default = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwYXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIscUNBQWtDO0FBR2xDOztHQUVHO0FBRUgsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDO0FBT3pCLFNBQVMsT0FBTyxDQUFDLE1BQWtCLEVBQUUsR0FBVztJQUUvQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUM1QjtRQUNDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUN4QjtJQUNELElBQUksQ0FBQyxHQUFlLEVBQUUsQ0FBQztJQUN2QixLQUFLLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFDekI7UUFDQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQ2pDO1lBQ0MsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0QjtLQUNEO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQixPQUFPLENBQUMsQ0FBQztBQUNWLENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBQyxLQUFlLEVBQUUsTUFBa0IsRUFBRSxHQUFXLEVBQUUsR0FBVztJQUU1RSxJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFekIsVUFBVTtJQUNWLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFDckQ7UUFDQyxPQUFPO0tBQ1A7SUFFRCxNQUFNO0lBQ04sSUFBSSxDQUFDLElBQUksRUFDVDtRQUNDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFD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QUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNYLElBQUksR0FBRyxLQUFLLENBQUMsRUFDYjtZQUNDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDZDtRQUNELElBQUksR0FBRyxLQUFLLENBQUMsRUFDYjtZQUNDLEtBQUssR0FBRyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFDdkI7WUFDQyxPQUFPLENBQUMsQ0FBQztTQUNUO0tBQ0Q7QUFDRixDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBRUgsU0FBZ0IsS0FBSyxDQUFDLEdBQThCLEVBQUUsT0FBdUI7SUFFNUUsSUFBSSxJQUFJLEtBQUssR0FBRyxJQUFJLEVBQUUsS0FBSyxHQUFHLEVBQzlCO1FBQ0MsT0FBTyxFQUFFLENBQUM7S0FDVjtJQUNELElBQUksQ0FBQyxPQUFPLEVBQ1o7UUFDQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0tBQ2I7SUFDRCxPQUFPLFFBQVEsS0FBSyxPQUFPLEdBQUc7UUFDN0IsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUM7UUFDbEIsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQWJELHNCQWFDO0FBRUQsa0JBQWUsS0FBSyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IGRlY29kZSB9IGZyb20gJy4vZGVjb2RlJztcbmltcG9ydCB7IElQYXJzZU9wdGlvbnMgfSBmcm9tICcuL3R5cGVzJztcblxuLyoqXG4gKiBDYWNoZSBub24taW50ZWdlciB0ZXN0IHJlZ2V4cC5cbiAqL1xuXG5jb25zdCBpc2ludCA9IC9eWzAtOV0rJC87XG5cbmludGVyZmFjZSBJUGFyc2VOb2RlIGV4dGVuZHMgUmVjb3JkPGFueSwgYW55Plxue1xuXHRiYXNlPzogSVBhcnNlTm9kZVxufVxuXG5mdW5jdGlvbiBwcm9tb3RlKHBhcmVudDogSVBhcnNlTm9kZSwga2V5OiBzdHJpbmcpXG57XG5cdGlmIChwYXJlbnRba2V5XS5sZW5ndGggPT09IDApXG5cdHtcblx0XHRyZXR1cm4gcGFyZW50W2tleV0gPSB7fTtcblx0fVxuXHRsZXQgdDogSVBhcnNlTm9kZSA9IHt9O1xuXHRmb3IgKGxldCBpIGluIHBhcmVudFtrZXldKVxuXHR7XG5cdFx0aWYgKHBhcmVudFtrZXldLmhhc093blByb3BlcnR5KGkpKVxuXHRcdHtcblx0XHRcdHRbaV0gPSBwYXJlbnRba2V5XVtpXTtcblx0XHR9XG5cdH1cblx0cGFyZW50W2tleV0gPSB0O1xuXHRyZXR1cm4gdDtcbn1cblxuZnVuY3Rpb24gX3BhcnNlKHBhcnRzOiBzdHJpbmdbXSwgcGFyZW50OiBJUGFyc2VOb2RlLCBrZXk6IHN0cmluZywgdmFsOiBzdHJpbmcpXG57XG5cdGxldCBwYXJ0ID0gcGFydHMuc2hpZnQoKTtcblxuXHQvLyBpbGxlZ2FsXG5cdGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChPYmplY3QucHJvdG90eXBlLCBrZXkpKVxuXHR7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0Ly8gZW5kXG5cdGlmICghcGFydClcblx0e1xuXHRcdGlmIChBcnJheS5pc0FycmF5KHBhcmVudFtrZXldKSlcblx0XHR7XG5cdFx0XHRwYXJlbnRba2V5XS5wdXNoKHZhbCk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKCdvYmplY3QnID09PSB0eXBlb2YgcGFyZW50W2tleV0pXG5cdFx0e1xuXHRcdFx0cGFyZW50W2tleV0gPSB2YWw7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKCd1bmRlZmluZWQnID09PSB0eXBlb2YgcGFyZW50W2tleV0pXG5cdFx0e1xuXHRcdFx0cGFyZW50W2tleV0gPSB2YWw7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRwYXJlbnRba2V5XSA9IFtwYXJlbnRba2V5XSwgdmFsXTtcblx0XHR9XG5cdFx0Ly8gYXJyYXlcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRsZXQgb2JqID0gcGFyZW50W2tleV0gPSBwYXJlbnRba2V5XSB8fCBbXTtcblx0XHRpZiAoJ10nID09PSBwYXJ0KVxuXHRcdHtcblx0XHRcdGlmIChBcnJheS5pc0FycmF5KG9iaikpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICgnJyAhPT0gdmFsKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0b2JqLnB1c2godmFsKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0ZWxzZSBpZiAoJ29iamVjdCcgPT09IHR5cGVvZiBvYmopXG5cdFx0XHR7XG5cdFx0XHRcdG9ialtPYmplY3Qua2V5cyhvYmopLmxlbmd0aF0gPSB2YWw7XG5cdFx0XHR9XG5cdFx0XHRlbHNlXG5cdFx0XHR7XG5cdFx0XHRcdG9iaiA9IHBhcmVudFtrZXldID0gW3BhcmVudFtrZXldLCB2YWxdO1xuXHRcdFx0fVxuXHRcdFx0Ly8gcHJvcFxuXHRcdH1cblx0XHRlbHNlIGlmICh+cGFydC5pbmRleE9mKCddJykpXG5cdFx0e1xuXHRcdFx0cGFydCA9IHBhcnQuc3Vic3RyKDAsIHBhcnQubGVuZ3RoIC0gMSk7XG5cdFx0XHRpZiAoIWlzaW50LnRlc3QocGFydCkgJiYgQXJyYXkuaXNBcnJheShvYmopKVxuXHRcdFx0e1xuXHRcdFx0XHRvYmogPSBwcm9tb3RlKHBhcmVudCwga2V5KTtcblx0XHRcdH1cblx0XHRcdF9wYXJzZShwYXJ0cywgb2JqLCBwYXJ0LCB2YWwpO1xuXHRcdFx0Ly8ga2V5XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRpZiAoIWlzaW50LnRlc3QocGFydCkgJiYgQXJyYXkuaXNBcnJheShvYmopKVxuXHRcdFx0e1xuXHRcdFx0XHRvYmogPSBwcm9tb3RlKHBhcmVudCwga2V5KTtcblx0XHRcdH1cblx0XHRcdF9wYXJzZShwYXJ0cywgb2JqLCBwYXJ0LCB2YWwpO1xuXHRcdH1cblx0fVxufVxuXG4vKipcbiAqIE1lcmdlIHBhcmVudCBrZXkvdmFsIHBhaXIuXG4gKi9cblxuZnVuY3Rpb24gbWVyZ2UocGFyZW50OiBJUGFyc2VOb2RlLCBrZXk6IHN0cmluZywgdmFsOiBzdHJpbmcpXG57XG5cdGlmICh+a2V5LmluZGV4T2YoJ10nKSlcblx0e1xuXHRcdGxldCBwYXJ0cyA9IGtleS5zcGxpdCgnWycpO1xuXHRcdGxldCBsZW4gPSBwYXJ0cy5sZW5ndGg7XG5cdFx0bGV0IGxhc3QgPSBsZW4gLSAxO1xuXHRcdF9wYXJzZShwYXJ0cywgcGFyZW50LCAnYmFzZScsIHZhbCk7XG5cdFx0Ly8gb3B0aW1pemVcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRpZiAoIWlzaW50LnRlc3Qoa2V5KSAmJiBBcnJheS5pc0FycmF5KHBhcmVudC5iYXNlKSlcblx0XHR7XG5cdFx0XHRsZXQgdCA9IHt9IGFzIFJlY29yZDxhbnksIGFueT47XG5cdFx0XHRmb3IgKGxldCBrIGluIHBhcmVudC5iYXNlKVxuXHRcdFx0e1xuXHRcdFx0XHR0W2tdID0gcGFyZW50LmJhc2Vba107XG5cdFx0XHR9XG5cdFx0XHRwYXJlbnQuYmFzZSA9IHQ7XG5cdFx0fVxuXHRcdHNldChwYXJlbnQuYmFzZSwga2V5LCB2YWwpO1xuXHR9XG5cblx0cmV0dXJuIHBhcmVudDtcbn1cblxuLyoqXG4gKiBDb21wYWN0IHNwYXJzZSBhcnJheXMuXG4gKi9cblxuZnVuY3Rpb24gY29tcGFjdChvYmo6IGFueVtdIHwgUmVjb3JkPGFueSwgYW55Pilcbntcblx0aWYgKCdvYmplY3QnICE9PSB0eXBlb2Ygb2JqKVxuXHR7cmV0dXJuIG9iajt9XG5cblx0aWYgKEFycmF5LmlzQXJyYXkob2JqKSlcblx0e1xuXHRcdGxldCByZXQgPSBbXTtcblxuXHRcdGZvciAobGV0IGkgaW4gb2JqKVxuXHRcdHtcblx0XHRcdGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGkpKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXQucHVzaChvYmpbaV0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiByZXQ7XG5cdH1cblxuXHRmb3IgKGxldCBrZXkgaW4gb2JqKVxuXHR7XG5cdFx0b2JqW2tleV0gPSBjb21wYWN0KG9ialtrZXldKTtcblx0fVxuXG5cdHJldHVybiBvYmo7XG59XG5cbi8qKlxuICogUGFyc2UgdGhlIGdpdmVuIG9iai5cbiAqL1xuXG5mdW5jdGlvbiBwYXJzZU9iamVjdChvYmo6IFJlY29yZDxhbnksIGFueT4pXG57XG5cdGxldCByZXQgPSB7IGJhc2U6IHt9IH07XG5cblx0T2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKVxuXHR7XG5cdFx0bWVyZ2UocmV0LCBuYW1lLCBvYmpbbmFtZV0pO1xuXHR9KTtcblxuXHRyZXR1cm4gY29tcGFjdChyZXQuYmFzZSk7XG59XG5cbi8qKlxuICogUGFyc2UgdGhlIGdpdmVuIHN0ci5cbiAqL1xuXG5mdW5jdGlvbiBwYXJzZVN0cmluZyhzdHI6IHVua25vd24gfCBzdHJpbmcsIG9wdGlvbnM6IElQYXJzZU9wdGlvbnMpXG57XG5cdGxldCByZXQgPSBTdHJpbmcoc3RyKS5zcGxpdCgnJicpLnJlZHVjZShmdW5jdGlvbiAocmV0LCBwYWlyKVxuXHR7XG5cdFx0bGV0IGVxbCA9IHBhaXIuaW5kZXhPZignPScpO1xuXHRcdGxldCBicmFjZSA9IGxhc3RCcmFjZUluS2V5KHBhaXIpO1xuXHRcdGxldCBrZXkgPSBwYWlyLnN1YnN0cigwLCBicmFjZSB8fCBlcWwpO1xuXHRcdGxldCB2YWwgPSBwYWlyLnN1YnN0cihicmFjZSB8fCBlcWwsIHBhaXIubGVuZ3RoKTtcblx0XHR2YWwgPSB2YWwuc3Vic3RyKHZhbC5pbmRleE9mKCc9JykgKyAxLCB2YWwubGVuZ3RoKTtcblxuXHRcdC8vID9mb29cblx0XHRpZiAoJycgPT09IGtleSlcblx0XHR7XG5cdFx0XHRrZXkgPSBwYWlyO1xuXHRcdFx0dmFsID0gJyc7XG5cdFx0fVxuXHRcdGlmICgnJyA9PT0ga2V5KVxuXHRcdHtcblx0XHRcdHJldHVybiByZXQ7XG5cdFx0fVxuXG5cdFx0bGV0IGNoYXJzZXQgPSBvcHRpb25zLmNoYXJzZXQ7XG5cdFx0cmV0dXJuIG1lcmdlKHJldCwgZGVjb2RlKGtleSksIGRlY29kZSh2YWwsIGNoYXJzZXQpKTtcblx0fSwge1xuXHRcdGJhc2U6IHt9XG5cdH0gYXMgSVBhcnNlTm9kZSkuYmFzZTtcblxuXHRyZXR1cm4gY29tcGFjdChyZXQpO1xufVxuXG4vKipcbiAqIFNldCBgb2JqYCdzIGBrZXlgIHRvIGB2YWxgIHJlc3BlY3RpbmdcbiAqIHRoZSB3ZWlyZCBhbmQgd29uZGVyZnVsIHN5bnRheCBvZiBhIHFzLFxuICogd2hlcmUgXCJmb289YmFyJmZvbz1iYXpcIiBiZWNvbWVzIGFuIGFycmF5LlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvYmpcbiAqIEBwYXJhbSB7U3RyaW5nfSBrZXlcbiAqIEBwYXJhbSB7U3RyaW5nfSB2YWxcbiAqIEBhcGkgcHJpdmF0ZVxuICovXG5cbmZ1bmN0aW9uIHNldChvYmo6IFJlY29yZDxhbnksIGFueT4sIGtleTogc3RyaW5nLCB2YWw6IHN0cmluZylcbntcblx0bGV0IHYgPSBvYmpba2V5XTtcblx0aWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKE9iamVjdC5wcm90b3R5cGUsIGtleSkpXG5cdHtyZXR1cm47fVxuXHRpZiAodW5kZWZpbmVkID09PSB2KVxuXHR7XG5cdFx0b2JqW2tleV0gPSB2YWw7XG5cdH1cblx0ZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2KSlcblx0e1xuXHRcdHYucHVzaCh2YWwpO1xuXHR9XG5cdGVsc2Vcblx0e1xuXHRcdG9ialtrZXldID0gW3YsIHZhbF07XG5cdH1cbn1cblxuLyoqXG4gKiBMb2NhdGUgbGFzdCBicmFjZSBpbiBgc3RyYCB3aXRoaW4gdGhlIGtleS5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gc3RyXG4gKiBAcmV0dXJuIHtOdW1iZXJ9XG4gKiBAYXBpIHByaXZhdGVcbiAqL1xuXG5mdW5jdGlvbiBsYXN0QnJhY2VJbktleShzdHI6IHN0cmluZylcbntcblx0bGV0IGxlbiA9IHN0ci5sZW5ndGg7XG5cdGxldCBicmFjZTogYm9vbGVhbjtcblx0bGV0IGM7XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyArK2kpXG5cdHtcblx0XHRjID0gc3RyW2ldO1xuXHRcdGlmICgnXScgPT09IGMpXG5cdFx0e1xuXHRcdFx0YnJhY2UgPSBmYWxzZTtcblx0XHR9XG5cdFx0aWYgKCdbJyA9PT0gYylcblx0XHR7XG5cdFx0XHRicmFjZSA9IHRydWU7XG5cdFx0fVxuXHRcdGlmICgnPScgPT09IGMgJiYgIWJyYWNlKVxuXHRcdHtcblx0XHRcdHJldHVybiBpO1xuXHRcdH1cblx0fVxufVxuXG4vKipcbiAqIFBhcnNlIHRoZSBnaXZlbiBxdWVyeSBgc3RyYCBvciBgb2JqYCwgcmV0dXJuaW5nIGFuIG9iamVjdC5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gc3RyIHwge09iamVjdH0gb2JqXG4gKiBAcmV0dXJuIHtPYmplY3R9XG4gKiBAYXBpIHB1YmxpY1xuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZShzdHI6IHN0cmluZyB8IFJlY29yZDxhbnksIGFueT4sIG9wdGlvbnM/OiBJUGFyc2VPcHRpb25zKVxue1xuXHRpZiAobnVsbCA9PT0gc3RyIHx8ICcnID09PSBzdHIpXG5cdHtcblx0XHRyZXR1cm4ge307XG5cdH1cblx0aWYgKCFvcHRpb25zKVxuXHR7XG5cdFx0b3B0aW9ucyA9IHt9O1xuXHR9XG5cdHJldHVybiAnb2JqZWN0JyA9PT0gdHlwZW9mIHN0clxuXHRcdD8gcGFyc2VPYmplY3Qoc3RyKVxuXHRcdDogcGFyc2VTdHJpbmcoc3RyLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgcGFyc2VcbiJdfQ==